apiVersion: v1
kind: Pod
metadata:
  name: beans-bungeecord
  labels:
    app: beans-bungeecord
spec:
  #securityContext:
  #  runAsUser: 1000
  #  runAsGroup: 1000
  #  fsGroup: 1000
  serviceAccountName: beans-bungeecord
  containers:
  - name: bungeecord-server
    image: itzg/bungeecord
    #securityContext:
    #  allowPrivilegeEscalation: false
    #  runAsNonRoot: true
    #  seccompProfile:
    #    type: RuntimeDefault
    #  capabilities:
    #    drop:
    #    - ALL
    env:
    - name: PLUGINS
      value: https://saggyresourcepack.blob.core.windows.net/www/BeansGameManager-1.0.jar
    readinessProbe:
      exec:
        command: [ "/usr/local/bin/mc-monitor", "status", "--host", "localhost" ]
      initialDelaySeconds: 20
      periodSeconds: 5
      failureThreshold: 20
    livenessProbe:
      exec:
        command: ["/usr/local/bin/mc-monitor", "status", "--host", "localhost"]
      initialDelaySeconds: 120
      periodSeconds: 60
    resources:
      requests:
        memory: "600Mi"
        cpu: "500m"
        ephemeral-storage: "1Gi"
      limits:
        memory: "1Gi"
        cpu: "2000m"
        ephemeral-storage: "10Gi"
    ports:
    - containerPort: 25565
    volumeMounts:
    - name: config
      mountPath: /config
  volumes:
    - name: config
      configMap:
        name: beans-bungeecord
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: beans-bungeecord
data:
  config.yml: |
    groups:
      boxhead_crafter:
      - admin
      Tomay0:
      - admin
    ip_forward: true
    listeners:
      - priorities: 
        - lobby
        motd: "Beans++"
        query_port: 25565
        host: 0.0.0.0:25565
    servers:
      lobby:
        motd: 'Beans++ lobby'
        address: ellie-lifted:25569  # i swear that wasn't intentional
        restricted: false
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: beans-bungeecord
rules:
- apiGroups: [""]
  resources: ["pods", "configmaps", "persistentvolumeclaims"]
  verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: beans-bungeecord
subjects:
- kind: ServiceAccount
  name: beans-bungeecord
roleRef:
  kind: Role 
  name: beans-bungeecord
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: beans-bungeecord
---
apiVersion: v1
kind: Service
metadata:
  name: beans-bungeecord-test
  annotations:
    "mc-router.itzg.me/externalServerName": "test.beans.isaacirvine.me"
spec:
  selector:
    app: beans-bungeecord
  ports:
  - protocol: TCP
    port: 25565
---
apiVersion: v1
kind: Service
metadata:
  name: beans-bungeecord
  annotations:
    "mc-router.itzg.me/externalServerName": "beans.isaacirvine.me"
spec:
  selector:
    app: beans-bungeecord
  ports:
  - protocol: TCP
    port: 25565
